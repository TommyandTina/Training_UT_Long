/***********************************************************************************************************************
* Copyright [2022-2024] Renesas Electronics Corporation and/or its licensors. All Rights Reserved.
*
* The contents of this file (the "contents") are proprietary and confidential to Renesas Electronics Corporation
* and/or its licensors ("Renesas") and subject to statutory and contractual protections.
*
* Unless otherwise expressly agreed in writing between Renesas and you: 1) you may not use, copy, modify, distribute,
* display, or perform the contents; 2) you may not use any name or mark of Renesas for advertising or publicity
* purposes or in connection with your use of the contents; 3) RENESAS MAKES NO WARRANTY OR REPRESENTATIONS ABOUT THE
* SUITABILITY OF THE CONTENTS FOR ANY PURPOSE; THE CONTENTS ARE PROVIDED "AS IS" WITHOUT ANY EXPRESS OR IMPLIED
* WARRANTY, INCLUDING THE IMPLIED WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, AND
* NON-INFRINGEMENT; AND 4) RENESAS SHALL NOT BE LIABLE FOR ANY DIRECT, INDIRECT, SPECIAL, OR CONSEQUENTIAL DAMAGES,
* INCLUDING DAMAGES RESULTING FROM LOSS OF USE, DATA, OR PROJECTS, WHETHER IN AN ACTION OF CONTRACT OR TORT, ARISING
* OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THE CONTENTS. Third-party contents included in this file may
* be subject to different terms.
***********************************************************************************************************************/
/***********************************************************************************************************************
* File Name :    r_osal_os_common.c
* Version :      1.2.0
* Product Name : OSAL
* Device(s) :    R-Car
* Description :  OSAL OS IFs for Common
***********************************************************************************************************************/

/***********************************************************************************************************************
 * includes
***********************************************************************************************************************/
#include <errno.h>
#include <stdlib.h>
#include <pthread.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/mman.h>
#include "target/linux/r_osal_os_types.h"

/***********************************************************************************************************************
 * @ingroup OSAL_WRAPPER OSAL WRAPPER
 *
 * @{
 **********************************************************************************************************************/

/***********************************************************************************************************************
 * Definition
***********************************************************************************************************************/
/***********************************************************************************************************************
 * @def     OSAL_WRAPPER_VERSION_MAJOR
 * @brief   OSAL wrapper major version.
***********************************************************************************************************************/
#define OSAL_WRAPPER_VERSION_MAJOR   (3)

/***********************************************************************************************************************
 * @def     OSAL_WRAPPER_VERSION_MINOR
 * @brief   OSAL wrapper minor version.
***********************************************************************************************************************/
#define OSAL_WRAPPER_VERSION_MINOR   (14)

/***********************************************************************************************************************
 * @def     OSAL_WRAPPER_VERSION_PATCH
 * @brief   OSAL wrapper patch version.
***********************************************************************************************************************/
#define OSAL_WRAPPER_VERSION_PATCH   (0)

/***********************************************************************************************************************
 * Global variable
***********************************************************************************************************************/
/***********************************************************************************************************************
 * @var     g_interrupt_thread_key
 * @brief   For judgment of ISR context. Extern from the interrupt manager.
***********************************************************************************************************************/
extern pthread_key_t g_interrupt_thread_key;

/***********************************************************************************************************************
 * XOS3_OSAL_LINUX_CD_CD_COM_101
***********************************************************************************************************************/
/***********************************************************************************************************************
* Start of function R_OSAL_OS_Open()
***********************************************************************************************************************/
/* PRQA S 5209 1 # System is requesting an int, so it cannot be changed. */
int R_OSAL_OS_Open(const char* p_pathname, int flags)
{
    /* PRQA S 5209 1 # System is requesting an int, so it cannot be changed. */
    int fd = 0;

    if (NULL != p_pathname)
    {
        fd = open(p_pathname, flags);
    }

    return fd;
}
/***********************************************************************************************************************
* End of function R_OSAL_OS_Open()
***********************************************************************************************************************/
/***********************************************************************************************************************
 * [Covers: XOS3_OSAL_LINUX_UD_DD_COM_005]
***********************************************************************************************************************/

/***********************************************************************************************************************
 * XOS3_OSAL_LINUX_CD_CD_COM_102
***********************************************************************************************************************/
/***********************************************************************************************************************
* Start of function R_OSAL_OS_Close()
***********************************************************************************************************************/
/* PRQA S 5209 2 # System is requesting an int, so it cannot be changed. */
/* PRQA S 9106 1 # This function is intended to be used in common. */
e_osal_return_t R_OSAL_OS_Close(int fd)
{
    e_osal_return_t osal_ret = OSAL_RETURN_OK;
    /* PRQA S 5209 1 # Return values from linux must be int. Used according to the specifications. */
    int             linux_ret;

    linux_ret = close(fd);
    if (0 != linux_ret)
    {
        osal_ret = OSAL_RETURN_FAIL;
    }

    return osal_ret;
}
/***********************************************************************************************************************
* End of function R_OSAL_OS_Close()
***********************************************************************************************************************/
/***********************************************************************************************************************
 * [Covers: XOS3_OSAL_LINUX_UD_DD_COM_006]
***********************************************************************************************************************/

/***********************************************************************************************************************
 * XOS3_OSAL_LINUX_CD_CD_COM_103
***********************************************************************************************************************/
/***********************************************************************************************************************
* Start of function R_OSAL_OS_Read()
***********************************************************************************************************************/
/* PRQA S 5209 1 # System is requesting an int, so it cannot be changed. */
e_osal_return_t R_OSAL_OS_Read(int fd, void* p_buf, size_t count)
{
    e_osal_return_t osal_ret = OSAL_RETURN_OK;
    ssize_t         size;

    if (NULL == p_buf)
    {
        osal_ret = OSAL_RETURN_FAIL;
    }

    if (OSAL_RETURN_OK == osal_ret)
    {
        size = read(fd, p_buf, count);
        if ((ssize_t)count != size)
        {
            osal_ret = OSAL_RETURN_FAIL;
        }
    }

    return osal_ret;
}
/***********************************************************************************************************************
* End of function R_OSAL_OS_Read()
***********************************************************************************************************************/
/***********************************************************************************************************************
 * [Covers: XOS3_OSAL_LINUX_UD_DD_COM_007]
***********************************************************************************************************************/

/***********************************************************************************************************************
 * XOS3_OSAL_LINUX_CD_CD_COM_104
***********************************************************************************************************************/
/***********************************************************************************************************************
* Start of function R_OSAL_OS_Write()
***********************************************************************************************************************/
/* PRQA S 5209 1 # System is requesting an int, so it cannot be changed. */
e_osal_return_t R_OSAL_OS_Write(int fd, const void* p_buf, size_t count)
{
    e_osal_return_t osal_ret = OSAL_RETURN_OK;
    ssize_t         size;

    if (NULL == p_buf)
    {
        osal_ret = OSAL_RETURN_FAIL;
    }

    if (OSAL_RETURN_OK == osal_ret)
    {
        size = write(fd, p_buf, count);
        if ((ssize_t)count != size)
        {
            osal_ret = OSAL_RETURN_FAIL;
        }
    }

    return osal_ret;
}
/***********************************************************************************************************************
* End of function R_OSAL_OS_Write()
***********************************************************************************************************************/
/***********************************************************************************************************************
 * [Covers: XOS3_OSAL_LINUX_UD_DD_COM_008]
***********************************************************************************************************************/

/***********************************************************************************************************************
 * XOS3_OSAL_LINUX_CD_CD_COM_105
***********************************************************************************************************************/
/***********************************************************************************************************************
* Start of function R_OSAL_OS_Malloc()
***********************************************************************************************************************/
/* PRQA S 9106 1 # This function is intended to be used in common. */
void* R_OSAL_OS_Malloc(size_t size)
{
    void* p_ptr;

    /* PRQA S 5118 1 # Freed in caller. */
    p_ptr = calloc(1, size);

    return p_ptr;
}
/***********************************************************************************************************************
* End of function R_OSAL_OS_Malloc()
***********************************************************************************************************************/
/***********************************************************************************************************************
 * [Covers: XOS3_OSAL_LINUX_UD_DD_COM_009]
***********************************************************************************************************************/

/***********************************************************************************************************************
 * XOS3_OSAL_LINUX_CD_CD_COM_106
***********************************************************************************************************************/
/***********************************************************************************************************************
* Start of function R_OSAL_OS_Free()
***********************************************************************************************************************/
/* PRQA S 9106 1 # This function is intended to be used in common. */
void R_OSAL_OS_Free(void* p_ptr)
{
    if (NULL != p_ptr)
    {
        /* PRQA S 5118 1 # Safety Manual, malloc use are allowed. */
        free(p_ptr);
    }
    return;
}
/***********************************************************************************************************************
* End of function R_OSAL_OS_Free()
***********************************************************************************************************************/
/***********************************************************************************************************************
 * [Covers: XOS3_OSAL_LINUX_UD_DD_COM_010]
***********************************************************************************************************************/

/***********************************************************************************************************************
 * XOS3_OSAL_LINUX_CD_CD_COM_109
***********************************************************************************************************************/
/***********************************************************************************************************************
* Start of function R_OSAL_OS_IsISRContext()
***********************************************************************************************************************/
/* PRQA S 9106 1 # This function is intended to be used in common. */
e_osal_return_t R_OSAL_OS_IsISRContext(bool *const p_is_isr)
{
    e_osal_return_t osal_ret = OSAL_RETURN_OK;
    void const*     p_res;

    if (NULL == p_is_isr)
    {
        osal_ret = OSAL_RETURN_FAIL;
    }

    if (OSAL_RETURN_OK == osal_ret)
    {
        /* The thread key exist          : ISR context      */
        /* The thread key does not exist : Not ISR context  */
        p_res = pthread_getspecific(g_interrupt_thread_key);
        if (NULL == p_res)
        {
            *p_is_isr = false;
        }
        else
        {
            *p_is_isr = true;
        }
    }

    return osal_ret;
}
/***********************************************************************************************************************
* End of function R_OSAL_OS_IsISRContext()
***********************************************************************************************************************/
/***********************************************************************************************************************
 * [Covers: XOS3_OSAL_LINUX_UD_DD_COM_011]
***********************************************************************************************************************/

/***********************************************************************************************************************
 * XOS3_OSAL_LINUX_CD_CD_COM_110
***********************************************************************************************************************/
/***********************************************************************************************************************
* Start of function R_OSAL_OS_GetSysPageSize()
***********************************************************************************************************************/
/* PRQA S 5209 1 # The long type of return value is a specification and cannot be changed. */
long R_OSAL_OS_GetSysPageSize(void)
{
    return sysconf(_SC_PAGESIZE);
}
/***********************************************************************************************************************
* End of function R_OSAL_OS_GetSysPageSize()
***********************************************************************************************************************/
/***********************************************************************************************************************
 * [Covers: XOS3_OSAL_LINUX_UD_DD_COM_014]
***********************************************************************************************************************/

/***********************************************************************************************************************
 * XOS3_OSAL_LINUX_CD_CD_COM_111
***********************************************************************************************************************/
/***********************************************************************************************************************
* Start of function R_OSAL_OS_BinarySearch()
***********************************************************************************************************************/
void* R_OSAL_OS_BinarySearch(const void* p_key, const void* p_array, size_t array_num, size_t array_size, p_osal_compare_func_t compare_function)
{
    e_osal_return_t osal_ret = OSAL_RETURN_OK;
    void*           p_ptr = NULL;

    if ((NULL == p_key) ||
        (NULL == p_array) ||
        (NULL == compare_function))
    {
        osal_ret = OSAL_RETURN_FAIL;
    }

    if (OSAL_RETURN_OK == osal_ret)
    {
        /* PRQA S 5135 1 # The search target array is not rewritten. */
        p_ptr = bsearch(p_key, p_array, array_num, array_size, compare_function);
    }

    return p_ptr;
}
/***********************************************************************************************************************
* End of function R_OSAL_OS_BinarySearch()
***********************************************************************************************************************/
/***********************************************************************************************************************
 * [Covers: XOS3_OSAL_LINUX_UD_DD_COM_015]
***********************************************************************************************************************/

/***********************************************************************************************************************
 * XOS3_OSAL_LINUX_CD_CD_COM_112
***********************************************************************************************************************/
/***********************************************************************************************************************
* Start of function R_OSAL_OS_GetWrapperVersion()
***********************************************************************************************************************/
/* PRQA S 3408 1 # Because the SoC-dependent processing is divided by the file, it cannot be avoided */
const st_osal_sub_version_t* R_OSAL_OS_GetWrapperVersion(void)
{
    static const st_osal_sub_version_t s_sub_version =
    {
        OSAL_WRAPPER_VERSION_MAJOR,
        OSAL_WRAPPER_VERSION_MINOR,
        OSAL_WRAPPER_VERSION_PATCH
    };

    return &s_sub_version;
}
/***********************************************************************************************************************
* End of function R_OSAL_OS_GetWrapperVersion()
***********************************************************************************************************************/
/***********************************************************************************************************************
 * [Covers: XOS3_OSAL_LINUX_UD_DD_COM_017]
***********************************************************************************************************************/

/** @} OSAL_WRAPPER */
