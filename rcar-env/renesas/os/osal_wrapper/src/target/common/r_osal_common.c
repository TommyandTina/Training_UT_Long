/***********************************************************************************************************************
* Copyright [2022-2023] Renesas Electronics Corporation and/or its licensors. All Rights Reserved.
*
* The contents of this file (the "contents") are proprietary and confidential to Renesas Electronics Corporation
* and/or its licensors ("Renesas") and subject to statutory and contractual protections.
*
* Unless otherwise expressly agreed in writing between Renesas and you: 1) you may not use, copy, modify, distribute,
* display, or perform the contents; 2) you may not use any name or mark of Renesas for advertising or publicity
* purposes or in connection with your use of the contents; 3) RENESAS MAKES NO WARRANTY OR REPRESENTATIONS ABOUT THE
* SUITABILITY OF THE CONTENTS FOR ANY PURPOSE; THE CONTENTS ARE PROVIDED "AS IS" WITHOUT ANY EXPRESS OR IMPLIED
* WARRANTY, INCLUDING THE IMPLIED WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, AND
* NON-INFRINGEMENT; AND 4) RENESAS SHALL NOT BE LIABLE FOR ANY DIRECT, INDIRECT, SPECIAL, OR CONSEQUENTIAL DAMAGES,
* INCLUDING DAMAGES RESULTING FROM LOSS OF USE, DATA, OR PROJECTS, WHETHER IN AN ACTION OF CONTRACT OR TORT, ARISING
* OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THE CONTENTS. Third-party contents included in this file may
* be subject to different terms.
***********************************************************************************************************************/
/***********************************************************************************************************************
* File Name :    r_osal_common.c
* Version :      1.0.0
* Product Name : OSAL
* Device(s) :    R-Car
* Description :  OSAL wrapper common functions
***********************************************************************************************************************/

/***********************************************************************************************************************
 * includes
***********************************************************************************************************************/
#include "target/common/r_osal_manager.h"

/*******************************************************************************************************************//**
 * @ingroup OSAL_WRAPPER OSAL WRAPPER
 *
 * @{
 **********************************************************************************************************************/

/*======================================================================================================================
 Private macro definitions
======================================================================================================================*/
/***********************************************************************************************************************
 * XOS3_OSAL_NOS_CD_CD_COM_007
***********************************************************************************************************************/
/***********************************************************************************************************************
 * @def OSAL_ISINIT_CLOCKTIME
 * @brief Initialization bit setting value for Clock&Time Manager
***********************************************************************************************************************/
#define OSAL_ISINIT_CLOCKTIME  (0x01U)

/***********************************************************************************************************************
 * @def OSAL_ISINIT_MQ
 * @briefInitialization bit setting value for Message Queue Manager
***********************************************************************************************************************/
#define OSAL_ISINIT_MQ         (0x02U)

/***********************************************************************************************************************
 * @def OSAL_ISINIT_THREADSYNC
 * @brief Initialization bit setting value for ThreadSync Manager
***********************************************************************************************************************/
#define OSAL_ISINIT_THREADSYNC (0x04U)

/***********************************************************************************************************************
 * @def OSAL_ISINIT_INTERRUPT
 * @brief Initialization bit setting value for Interrupt Manager
***********************************************************************************************************************/
#define OSAL_ISINIT_INTERRUPT  (0x08U)

/***********************************************************************************************************************
 * @def OSAL_ISINIT_PM
 * @brief Initialization bit setting value for Power Manager
***********************************************************************************************************************/
#define OSAL_ISINIT_PM         (0x10U)

/***********************************************************************************************************************
 * @def OSAL_ISINIT_IO
 * @brief Initialization bit setting value for IO Manager
***********************************************************************************************************************/
#define OSAL_ISINIT_IO         (0x20U)

/***********************************************************************************************************************
 * @def OSAL_ISINIT_MEMORY
 * @brief Initialization bit setting value for Memory Manager
***********************************************************************************************************************/
#define OSAL_ISINIT_MEMORY     (0x40U)

/***********************************************************************************************************************
 * @def OSAL_ISINIT_THREAD
 * @brief Initialization bit setting value for Thread Manager
***********************************************************************************************************************/
#define OSAL_ISINIT_THREAD     (0x80U)
/***********************************************************************************************************************
 * [Covers: XOS3_OSAL_NOS_UD_DD_COM_016]
***********************************************************************************************************************/

/*======================================================================================================================
 Private function prototypes
======================================================================================================================*/
/***********************************************************************************************************************
* @brief            Initialize of device-related manager
* @return           #e_osal_return_t
* @retval           OSAL_RETURN_OK
* @retval           OSAL_RETURN_MEM
* @retval           OSAL_RETURN_DEV
* @retval           OSAL_RETURN_CONF
* @retval           OSAL_RETURN_FAIL
* @retval           OSAL_RETURN_STATE
***********************************************************************************************************************/
static e_osal_return_t r_osal_device_related_initialize(void);

/***********************************************************************************************************************
* @brief            Undo the initialization
* @return           void
***********************************************************************************************************************/
static void r_osal_undo_initialize(void);

/***********************************************************************************************************************
* @brief            Undo the device-related initialization
* @return           void
***********************************************************************************************************************/
static void r_osal_undo_device_related_initialize(void);

/***********************************************************************************************************************
* @brief            Pre-check for Deinitialize
* @return           #e_osal_return_t
* @retval           OSAL_RETURN_OK
* @retval           OSAL_RETURN_FAIL
* @retval           OSAL_RETURN_STATE
***********************************************************************************************************************/
static e_osal_return_t r_osal_deinitialize_pre(void);

/***********************************************************************************************************************
* @brief            Pre-check for Deinitialize of device-related manager
* @param[in/out]    p_init_flg  Pointer of Initialization target manager determination flag.
* @return           #e_osal_return_t
* @retval           OSAL_RETURN_OK
* @retval           OSAL_RETURN_FAIL
* @retval           OSAL_RETURN_STATE
***********************************************************************************************************************/
static e_osal_return_t r_osal_device_related_deinitialize_pre(uint16_t *p_init_flag);

/***********************************************************************************************************************
* @brief            Recovery the OSAL Manager initialization flag.
* @param[in]        init_flg   Initialization target manager determination flag.
* @return           void
***********************************************************************************************************************/
static void r_osal_recover_init_state(uint16_t init_flg);

/***********************************************************************************************************************
* @brief            Recovery the OSAL device-related Manager initialization flag.
* @param[in]        init_flg   Initialization target manager determination flag.
* @return           void
***********************************************************************************************************************/
static void r_osal_recover_device_related_init_state(uint16_t init_flg);

/***********************************************************************************************************************
* @brief            Deinitialize of device-related manager
* @return           #e_osal_return_t
* @retval           OSAL_RETURN_OK
* @retval           OSAL_RETURN_FAIL
***********************************************************************************************************************/
static e_osal_return_t r_osal_device_related_deinitialize(void);

/*======================================================================================================================
 Public function definitions
======================================================================================================================*/
/***********************************************************************************************************************
 * XOS3_OSAL_NOS_CD_CD_COM_001
***********************************************************************************************************************/
/***********************************************************************************************************************
* Start of function R_OSAL_Initialize()
***********************************************************************************************************************/
e_osal_return_t R_OSAL_Initialize(void)
{
    /*------------------------------------------------------------------------------------------------------------------
    Local variables
    ------------------------------------------------------------------------------------------------------------------*/
    e_osal_return_t osal_ret;

    /*------------------------------------------------------------------------------------------------------------------
    Function body
    ------------------------------------------------------------------------------------------------------------------*/
    osal_ret = R_OSAL_ClockTimeInitialize();
    if (OSAL_RETURN_OK == osal_ret)
    {
        osal_ret = R_OSAL_ThreadInitialize();
    }
    else
    {
        /* Do nothing */
    }

    if (OSAL_RETURN_OK == osal_ret)
    {
        osal_ret = R_OSAL_ThsyncInitialize();
    }
    else
    {
        /* Do nothing */
    }

    if (OSAL_RETURN_OK == osal_ret)
    {
        osal_ret = R_OSAL_MqInitialize();
    }
    else
    {
        /* Do nothing */
    }

    if (OSAL_RETURN_OK == osal_ret)
    {
        osal_ret = r_osal_device_related_initialize();
    }
    else
    {
        /* Do nothing */
    }

    if (OSAL_RETURN_OK == osal_ret)
    {
        osal_ret = R_OSAL_MmngrInitialize();
    }
    else
    {
        /* Do nothing */
    }

    if ((OSAL_RETURN_OK != osal_ret) && (OSAL_RETURN_STATE != osal_ret))
    {
        r_osal_undo_initialize();
    }
    else
    {
        /* Do nothing */
    }

    return osal_ret;
}
/***********************************************************************************************************************
* End of function R_OSAL_Initialize()
***********************************************************************************************************************/
/***********************************************************************************************************************
 * [Covers: XOS3_OSAL_NOS_UD_DD_COM_001]
***********************************************************************************************************************/

/***********************************************************************************************************************
 * XOS3_OSAL_NOS_CD_CD_COM_002
***********************************************************************************************************************/
/***********************************************************************************************************************
* Start of function R_OSAL_Deinitialize()
***********************************************************************************************************************/
e_osal_return_t R_OSAL_Deinitialize(void)
{
    /*------------------------------------------------------------------------------------------------------------------
    Local variables
    ------------------------------------------------------------------------------------------------------------------*/
    e_osal_return_t osal_ret;
    e_osal_return_t local_ret;

    /*------------------------------------------------------------------------------------------------------------------
    Function body
    ------------------------------------------------------------------------------------------------------------------*/
    osal_ret = r_osal_deinitialize_pre();
    if (OSAL_RETURN_OK == osal_ret)
    {
        R_OSAL_ClockTimeDeinitialize();
        /* The variable is changed so as not to overwrite the error factor. */
        osal_ret  = R_OSAL_MqDeinitialize();
        local_ret = R_OSAL_ThsyncDeinitialize();
        if (OSAL_RETURN_OK == osal_ret)
        {
            osal_ret = local_ret;
        }
        else
        {
            /* Do nothing */
        }

        local_ret = r_osal_device_related_deinitialize();
        if (OSAL_RETURN_OK == osal_ret)
        {
            osal_ret = local_ret;
        }
        else
        {
            /* Do nothing */
        }

        local_ret = R_OSAL_MmngrDeinitialize();
        if (OSAL_RETURN_OK == osal_ret)
        {
            osal_ret = local_ret;
        }
        else
        {
            /* Do nothing */
        }

        local_ret = R_OSAL_ThreadDeinitialize();
        if (OSAL_RETURN_OK == osal_ret)
        {
            osal_ret = local_ret;
        }
        else
        {
            /* Do nothing */
        }
    }
    else
    {
        /* Do nothing */
    }   /* end of if (OSAL_RETURN_OK == osal_ret) */

    return osal_ret;
}
/***********************************************************************************************************************
* End of function R_OSAL_Deinitialize()
***********************************************************************************************************************/
/***********************************************************************************************************************
 * [Covers: XOS3_OSAL_NOS_UD_DD_COM_002]
***********************************************************************************************************************/

/***********************************************************************************************************************
 * XOS3_OSAL_NOS_CD_CD_COM_009
***********************************************************************************************************************/
/***********************************************************************************************************************
* Start of function r_osal_device_related_initialize()
***********************************************************************************************************************/
/* This function is implemented as a part of R_OSAL_Initialize() in order to improve the result of 
   static code analysis (STCAL of HIS code metrics). */
static e_osal_return_t r_osal_device_related_initialize(void)
{
    /*------------------------------------------------------------------------------------------------------------------
    Local variables
    ------------------------------------------------------------------------------------------------------------------*/
    e_osal_return_t osal_ret;

    /*------------------------------------------------------------------------------------------------------------------
    Function body
    ------------------------------------------------------------------------------------------------------------------*/
    osal_ret = R_OSAL_IoInitialize();
    if (OSAL_RETURN_OK == osal_ret)
    {
        osal_ret = R_OSAL_PmInitialize();
    }
    else
    {
        /* Do nothing */
    }

    if (OSAL_RETURN_OK == osal_ret)
    {
        osal_ret = R_OSAL_InterruptInitialize();
    }
    else
    {
        /* Do nothing */
    }

    return osal_ret;
}
/***********************************************************************************************************************
* End of function r_osal_device_related_initialize()
***********************************************************************************************************************/
/***********************************************************************************************************************
 * [Covers: XOS3_OSAL_NOS_UD_DD_COM_001]
***********************************************************************************************************************/

/***********************************************************************************************************************
 * XOS3_OSAL_NOS_CD_CD_COM_003
***********************************************************************************************************************/
/***********************************************************************************************************************
* Start of function r_osal_undo_initialize()
***********************************************************************************************************************/
static void r_osal_undo_initialize(void)
{
    /*------------------------------------------------------------------------------------------------------------------
    Local variables
    ------------------------------------------------------------------------------------------------------------------*/

    /*------------------------------------------------------------------------------------------------------------------
    Function body
    ------------------------------------------------------------------------------------------------------------------*/
    (void)R_OSAL_ClockTimeDeinitialize();
    (void)R_OSAL_MqDeinitialize();
    (void)R_OSAL_ThsyncDeinitialize();
    r_osal_undo_device_related_initialize();
    (void)R_OSAL_MmngrDeinitialize();
    (void)R_OSAL_ThreadDeinitialize();

    return;
}
/***********************************************************************************************************************
* End of function r_osal_undo_initialize()
***********************************************************************************************************************/
/***********************************************************************************************************************
 * [Covers: XOS3_OSAL_NOS_UD_DD_COM_015]
***********************************************************************************************************************/

/***********************************************************************************************************************
 * XOS3_OSAL_NOS_CD_CD_COM_010
***********************************************************************************************************************/
/***********************************************************************************************************************
* Start of function r_osal_undo_device_related_initialize()
***********************************************************************************************************************/
/* This function is implemented as a part of r_osal_undo_initialize() in order to improve the result of 
   static code analysis (STCAL of HIS code metrics). */
static void r_osal_undo_device_related_initialize(void)
{
    /*------------------------------------------------------------------------------------------------------------------
    Local variables
    ------------------------------------------------------------------------------------------------------------------*/

    /*------------------------------------------------------------------------------------------------------------------
    Function body
    ------------------------------------------------------------------------------------------------------------------*/
    (void)R_OSAL_InterruptDeinitialize();
    (void)R_OSAL_PmDeinitialize();
    (void)R_OSAL_IoDeinitialize();

    return;
}
/***********************************************************************************************************************
* End of function r_osal_undo_device_related_initialize()
***********************************************************************************************************************/
/***********************************************************************************************************************
 * [Covers: XOS3_OSAL_NOS_UD_DD_COM_015]
***********************************************************************************************************************/

/***********************************************************************************************************************
 * XOS3_OSAL_NOS_CD_CD_COM_004
***********************************************************************************************************************/
/***********************************************************************************************************************
* Start of function r_osal_deinitialize_pre()
***********************************************************************************************************************/
static e_osal_return_t r_osal_deinitialize_pre(void)
{
    /*------------------------------------------------------------------------------------------------------------------
    Local variables
    ------------------------------------------------------------------------------------------------------------------*/
    e_osal_return_t osal_ret;
    uint16_t        init_flg = 0U;

    /*------------------------------------------------------------------------------------------------------------------
    Function body
    ------------------------------------------------------------------------------------------------------------------*/
    osal_ret = R_OSAL_ClockTimeCheckBusy();
    if (OSAL_RETURN_OK == osal_ret)
    {
        init_flg |= OSAL_ISINIT_CLOCKTIME;
    }
    else
    {
        /* Do nothing */
    }

    if (OSAL_RETURN_OK == osal_ret)
    {
        osal_ret = R_OSAL_MqCheckBusy();
        if (OSAL_RETURN_OK == osal_ret)
        {
            init_flg |= OSAL_ISINIT_MQ;
        }
        else
        {
            /* Do nothing */
        }
    }
    else
    {
        /* Do nothing */
    }

    if (OSAL_RETURN_OK == osal_ret)
    {
        osal_ret = R_OSAL_ThsyncCheckBusy();
        if (OSAL_RETURN_OK == osal_ret)
        {
            init_flg |= OSAL_ISINIT_THREADSYNC;
        }
        else
        {
            /* Do nothing */
        }
    }
    else
    {
        /* Do nothing */
    }

    if (OSAL_RETURN_OK == osal_ret)
    {
        osal_ret = r_osal_device_related_deinitialize_pre(&init_flg);
    }
    else
    {
        /* Do nothing */
    }

    if (OSAL_RETURN_OK == osal_ret)
    {
        osal_ret = R_OSAL_MmngrCheckBusy();
        if (OSAL_RETURN_OK == osal_ret)
        {
            init_flg |= OSAL_ISINIT_MEMORY;
        }
        else
        {
            /* Do nothing */
        }
    }
    else
    {
        /* Do nothing */
    }

    if (OSAL_RETURN_OK == osal_ret)
    {
        osal_ret = R_OSAL_ThreadCheckBusy();
        init_flg |= OSAL_ISINIT_THREAD;
    }
    else
    {
        /* Do nothing */
    }

    if (OSAL_RETURN_OK != osal_ret)
    {
        r_osal_recover_init_state(init_flg);
    }
    else
    {
        /* Do nothing */
    }

    return osal_ret;
    /* PRQA S 9104 1 # For better readability this rule is ignored and this function is not split. */
}
/***********************************************************************************************************************
* End of function r_osal_deinitialize_pre()
***********************************************************************************************************************/
/***********************************************************************************************************************
 * [Covers: XOS3_OSAL_NOS_UD_DD_COM_004]
***********************************************************************************************************************/

/***********************************************************************************************************************
 * XOS3_OSAL_NOS_CD_CD_COM_011
***********************************************************************************************************************/
/***********************************************************************************************************************
* Start of function r_osal_device_related_deinitialize_pre()
***********************************************************************************************************************/
/* This function is implemented as a part of r_osal_deinitialize_pre() in order to improve the result of 
   static code analysis (STCAL of HIS code metrics). */
static e_osal_return_t r_osal_device_related_deinitialize_pre(uint16_t *p_init_flag)
{
    /*------------------------------------------------------------------------------------------------------------------
    Local variables
    ------------------------------------------------------------------------------------------------------------------*/
    e_osal_return_t osal_ret;

    /*------------------------------------------------------------------------------------------------------------------
    Function body
    ------------------------------------------------------------------------------------------------------------------*/
    osal_ret = R_OSAL_InterruptCheckBusy();
    if (OSAL_RETURN_OK == osal_ret)
    {
        *p_init_flag |= OSAL_ISINIT_INTERRUPT;
    }
    else
    {
        /* Do nothing */
    }

    if (OSAL_RETURN_OK == osal_ret)
    {
        osal_ret = R_OSAL_PmCheckBusy();
        if (OSAL_RETURN_OK == osal_ret)
        {
            *p_init_flag |= OSAL_ISINIT_PM;
        }
        else
        {
            /* Do nothing */
        }
    }
    else
    {
        /* Do nothing */
    }

    if (OSAL_RETURN_OK == osal_ret)
    {
        osal_ret = R_OSAL_IoCheckBusy();
        if (OSAL_RETURN_OK == osal_ret)
        {
            *p_init_flag |= OSAL_ISINIT_IO;
        }
        else
        {
            /* Do nothing */
        }
    }
    else
    {
        /* Do nothing */
    }

    return osal_ret;
}
/***********************************************************************************************************************
* End of function r_osal_device_related_deinitialize_pre()
***********************************************************************************************************************/
/***********************************************************************************************************************
 * [Covers: XOS3_OSAL_NOS_UD_DD_COM_004]
***********************************************************************************************************************/

/***********************************************************************************************************************
 * XOS3_OSAL_NOS_CD_CD_COM_005
***********************************************************************************************************************/
/***********************************************************************************************************************
* Start of function r_osal_recover_init_state()
***********************************************************************************************************************/
static void r_osal_recover_init_state(uint16_t init_flg)
{
    /*------------------------------------------------------------------------------------------------------------------
    Local variables
    ------------------------------------------------------------------------------------------------------------------*/

    /*------------------------------------------------------------------------------------------------------------------
    Function body
    ------------------------------------------------------------------------------------------------------------------*/
    if (OSAL_ISINIT_CLOCKTIME == (init_flg & OSAL_ISINIT_CLOCKTIME))
    {
        R_OSAL_ClockTimeSetInit();
    }
    else
    {
        /* Do nothing */
    }

    if (OSAL_ISINIT_MQ == (init_flg & OSAL_ISINIT_MQ))
    {
        R_OSAL_MqSetInit();
    }
    else
    {
        /* Do nothing */
    }

    if (OSAL_ISINIT_THREADSYNC == (init_flg & OSAL_ISINIT_THREADSYNC))
    {
        R_OSAL_ThsyncSetInit();
    }
    else
    {
        /* Do nothing */
    }

    r_osal_recover_device_related_init_state(init_flg);

    if (OSAL_ISINIT_MEMORY == (init_flg & OSAL_ISINIT_MEMORY))
    {
        R_OSAL_MmngrSetInit();
    }
    else
    {
        /* Do nothing */
    }

    if (OSAL_ISINIT_THREAD == (init_flg & OSAL_ISINIT_THREAD))
    {
        R_OSAL_ThreadSetInit();
    }
    else
    {
        /* Do nothing */
    }

    return;
}
/***********************************************************************************************************************
* End of function r_osal_recover_init_state()
***********************************************************************************************************************/
/***********************************************************************************************************************
 * [Covers: XOS3_OSAL_NOS_UD_DD_COM_005]
***********************************************************************************************************************/

/***********************************************************************************************************************
 * XOS3_OSAL_NOS_CD_CD_COM_012
***********************************************************************************************************************/
/***********************************************************************************************************************
* Start of function r_osal_recover_device_related_init_state()
***********************************************************************************************************************/
/* This function is implemented as a part of r_osal_recover_init_state() in order to improve the result of 
   static code analysis (STCAL of HIS code metrics). */
static void r_osal_recover_device_related_init_state(uint16_t init_flg)
{
    /*------------------------------------------------------------------------------------------------------------------
    Local variables
    ------------------------------------------------------------------------------------------------------------------*/

    /*------------------------------------------------------------------------------------------------------------------
    Function body
    ------------------------------------------------------------------------------------------------------------------*/
    if (OSAL_ISINIT_INTERRUPT == (init_flg & OSAL_ISINIT_INTERRUPT))
    {
        R_OSAL_InterruptSetInit();
    }
    else
    {
        /* Do nothing */
    }

    if (OSAL_ISINIT_PM == (init_flg & OSAL_ISINIT_PM))
    {
        R_OSAL_PmSetInit();
    }
    else
    {
        /* Do nothing */
    }

    if (OSAL_ISINIT_IO == (init_flg & OSAL_ISINIT_IO))
    {
        R_OSAL_IoSetInit();
    }
    else
    {
        /* Do nothing */
    }

    return;
}
/***********************************************************************************************************************
* End of function r_osal_recover_device_related_init_state()
***********************************************************************************************************************/
/***********************************************************************************************************************
 * [Covers: XOS3_OSAL_NOS_UD_DD_COM_005]
***********************************************************************************************************************/

/***********************************************************************************************************************
 * XOS3_OSAL_NOS_CD_CD_COM_013
***********************************************************************************************************************/
/***********************************************************************************************************************
* Start of function r_osal_device_related_deinitialize()
***********************************************************************************************************************/
/* This function is implemented as a part of R_OSAL_Deinitialize() in order to improve the result of 
   static code analysis (STCAL of HIS code metrics). */
static e_osal_return_t r_osal_device_related_deinitialize(void)
{
    /*------------------------------------------------------------------------------------------------------------------
    Local variables
    ------------------------------------------------------------------------------------------------------------------*/
    e_osal_return_t osal_ret;
    e_osal_return_t local_ret;

    /*------------------------------------------------------------------------------------------------------------------
    Function body
    ------------------------------------------------------------------------------------------------------------------*/
    /* The variable is changed so as not to overwrite the error factor. */
    osal_ret = R_OSAL_InterruptDeinitialize();
    local_ret = R_OSAL_PmDeinitialize();
    if (OSAL_RETURN_OK == osal_ret)
    {
        osal_ret = local_ret;
    }
    else
    {
        /* Do nothing */
    }

    local_ret = R_OSAL_IoDeinitialize();
    if (OSAL_RETURN_OK == osal_ret)
    {
        osal_ret = local_ret;
    }
    else
    {
        /* Do nothing */
    }

    return osal_ret;
}
/***********************************************************************************************************************
* End of function r_osal_device_related_deinitialize()
***********************************************************************************************************************/
/***********************************************************************************************************************
 * [Covers: XOS3_OSAL_NOS_UD_DD_COM_002]
***********************************************************************************************************************/

/** @} OSAL_WRAPPER */

/*======================================================================================================================
End of File
======================================================================================================================*/
