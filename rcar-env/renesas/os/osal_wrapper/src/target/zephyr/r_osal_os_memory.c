/***********************************************************************************************************************
* Copyright [2022] Renesas Electronics Corporation and/or its licensors. All Rights Reserved.
*
* The contents of this file (the "contents") are proprietary and confidential to Renesas Electronics Corporation
* and/or its licensors ("Renesas") and subject to statutory and contractual protections.
*
* Unless otherwise expressly agreed in writing between Renesas and you: 1) you may not use, copy, modify, distribute,
* display, or perform the contents; 2) you may not use any name or mark of Renesas for advertising or publicity
* purposes or in connection with your use of the contents; 3) RENESAS MAKES NO WARRANTY OR REPRESENTATIONS ABOUT THE
* SUITABILITY OF THE CONTENTS FOR ANY PURPOSE; THE CONTENTS ARE PROVIDED "AS IS" WITHOUT ANY EXPRESS OR IMPLIED
* WARRANTY, INCLUDING THE IMPLIED WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, AND
* NON-INFRINGEMENT; AND 4) RENESAS SHALL NOT BE LIABLE FOR ANY DIRECT, INDIRECT, SPECIAL, OR CONSEQUENTIAL DAMAGES,
* INCLUDING DAMAGES RESULTING FROM LOSS OF USE, DATA, OR PROJECTS, WHETHER IN AN ACTION OF CONTRACT OR TORT, ARISING
* OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THE CONTENTS. Third-party contents included in this file may
* be subject to different terms.
***********************************************************************************************************************/
/***********************************************************************************************************************
* File Name :    r_osal_os_memory.c
* Version :      0.1.0
* Product Name : OSAL
* Device(s) :    R-Car
* Description :  Memory Related OS IFs
***********************************************************************************************************************/

/***********************************************************************************************************************
 * includes
***********************************************************************************************************************/
#include <stdlib.h>
#include <string.h>
#include <zephyr/cache.h>

#include "target/zephyr/r_osal_os_type.h"
#include "target/common/res_cfg/r_osal_res_cfg_memory.h"

/*******************************************************************************************************************//**
 * @ingroup OSAL_WRAPPER OSAL WRAPPER
 *
 * @{
 **********************************************************************************************************************/

/*======================================================================================================================
 Private function prototypes
======================================================================================================================*/

/*======================================================================================================================
 Public function definitions
======================================================================================================================*/
/***********************************************************************************************************************
 * XOS3_OSAL_ZEPHYR_CD_CD_MEM_001
***********************************************************************************************************************/
/***********************************************************************************************************************
* Start of function R_OSAL_OS_MmngrMap()
***********************************************************************************************************************/
e_osal_return_t R_OSAL_OS_MmngrMap(osal_mem_mmngr_ptr_self_t mngr_control,
                                   const st_osal_mmngr_config_t * const p_usr_config,
                                   osal_memory_region_idx_t region_idx)
{
    /*------------------------------------------------------------------------------------------------------------------
    Local variables
    ------------------------------------------------------------------------------------------------------------------*/
    e_osal_return_t                     osal_ret    = OSAL_RETURN_OK;
    const st_osal_mmngr_region_info_t   *p_info     = &g_osal_memory_region_info_list.p_info[region_idx];

    /*------------------------------------------------------------------------------------------------------------------
    Function body
    ------------------------------------------------------------------------------------------------------------------*/
    mngr_control->size = p_usr_config->memory_limit + OSAL_RES_CFG_MMNGR_MEM_RESERVE_SIZE;

    /* PRQA S 0326 1 # Cast between a pointer to void and uintptr_t is possible. */
    mngr_control->p_virtual_addr = (void*)p_info->offset;
    
    if (NULL == mngr_control->p_virtual_addr)
    {
        osal_ret = OSAL_RETURN_MEM;
    }
    else
    {
        /* PRQA S 0326 1 # Cast between a pointer to void and uintptr_t is possible. */
        mngr_control->physical_addr  = (uintptr_t)mngr_control->p_virtual_addr;
    } /* end of if (NULL == mngr_control->p_virtual_addr). */

    return osal_ret;

}
/***********************************************************************************************************************
* End of function R_OSAL_OS_MmngrMap()
***********************************************************************************************************************/
/***********************************************************************************************************************
 * [Covers: XOS3_OSAL_ZEPHYR_UD_DD_MEM_044]
***********************************************************************************************************************/

/***********************************************************************************************************************
 * XOS3_OSAL_ZEPHYR_CD_CD_MEM_002
***********************************************************************************************************************/
/***********************************************************************************************************************
* Start of function R_OSAL_OS_MmngrUnmap()
***********************************************************************************************************************/
e_osal_return_t R_OSAL_OS_MmngrUnmap(osal_mem_mmngr_ptr_self_t mngr_control)
{
    /*------------------------------------------------------------------------------------------------------------------
    Local variables
    ------------------------------------------------------------------------------------------------------------------*/
    e_osal_return_t osal_ret = OSAL_RETURN_OK;

    /*------------------------------------------------------------------------------------------------------------------
    Function body
    ------------------------------------------------------------------------------------------------------------------*/
    if (NULL != mngr_control)
    {
        mngr_control->p_virtual_addr = NULL;
    }
    else
    {
        osal_ret = OSAL_RETURN_FAIL;
    }

    return osal_ret;
}
/***********************************************************************************************************************
* End of function R_OSAL_OS_MmngrUnmap()
***********************************************************************************************************************/
/***********************************************************************************************************************
 * [Covers: XOS3_OSAL_ZEPHYR_UD_DD_MEM_045]
***********************************************************************************************************************/

/***********************************************************************************************************************
 * XOS3_OSAL_ZEPHYR_CD_CD_MEM_003
***********************************************************************************************************************/
/***********************************************************************************************************************
* Start of function R_OSAL_OS_MmngrFlush()
***********************************************************************************************************************/
/* PRQA S 3673 1 # From the concept of handles, const is unnecessary. */
e_osal_return_t R_OSAL_OS_MmngrFlush(osal_memory_buffer_handle_t memory_buffer_obj_hndl,
                                     uintptr_t addr,
                                     size_t offset,
                                     size_t size)
{
    /*------------------------------------------------------------------------------------------------------------------
    Local variables
    ------------------------------------------------------------------------------------------------------------------*/
    e_osal_return_t osal_ret = OSAL_RETURN_OK;
    int             os_ret; /* PRQA S 5209 # System is requesting an int, so it cannot be changed. */

    /*------------------------------------------------------------------------------------------------------------------
    Function body
    ------------------------------------------------------------------------------------------------------------------*/
    /* unused */
    (void)memory_buffer_obj_hndl;

    /* PRQA S 3335 2 # QAC false indication */
    /* PRQA S 0326 1 # Cast between a pointer to void and uintptr_t is possible. */
    os_ret = cache_data_range((void *)(addr + offset), size, K_CACHE_WB);
    if (0 != os_ret)
    {
        osal_ret = OSAL_RETURN_FAIL;
    }
    else
    {
        /* Do nothing */
    }

    return osal_ret;
}
/***********************************************************************************************************************
* End of function R_OSAL_OS_MmngrFlush()
***********************************************************************************************************************/
/***********************************************************************************************************************
 * [Covers: XOS3_OSAL_ZEPHYR_UD_DD_MEM_046]
***********************************************************************************************************************/

/***********************************************************************************************************************
 * XOS3_OSAL_ZEPHYR_CD_CD_MEM_004
***********************************************************************************************************************/
/***********************************************************************************************************************
* Start of function R_OSAL_OS_MmngrInvalidate()
***********************************************************************************************************************/
/* PRQA S 3673 1 # From the concept of handles, const is unnecessary. */
e_osal_return_t R_OSAL_OS_MmngrInvalidate(osal_memory_buffer_handle_t memory_buffer_obj_hndl,
                                          uintptr_t addr,
                                          size_t offset,
                                          size_t size)
{
    /*------------------------------------------------------------------------------------------------------------------
    Local variables
    ------------------------------------------------------------------------------------------------------------------*/
    e_osal_return_t osal_ret = OSAL_RETURN_OK;
    int             os_ret; /* PRQA S 5209 # System is requesting an int, so it cannot be changed. */

    /*------------------------------------------------------------------------------------------------------------------
    Function body
    ------------------------------------------------------------------------------------------------------------------*/
    /* unused */
    (void)memory_buffer_obj_hndl;

    /* PRQA S 0326 1 # Cast between a pointer to void and uintptr_t is possible. */
    os_ret = cache_data_range((void *)(addr + offset), size, K_CACHE_INVD);
    if (0 != os_ret)
    {
        osal_ret = OSAL_RETURN_FAIL;
    }
    else
    {
        /* Do nothing */
    }

    return osal_ret;
}
/***********************************************************************************************************************
* End of function R_OSAL_OS_MmngrInvalidate()
***********************************************************************************************************************/
/***********************************************************************************************************************
 * [Covers: XOS3_OSAL_ZEPHYR_UD_DD_MEM_047]
***********************************************************************************************************************/

/** @} OSAL_WRAPPER */

/*======================================================================================================================
End of File
======================================================================================================================*/
